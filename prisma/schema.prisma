// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 用户表 - Auth.js 需要的基础表
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                   String        @id @default(cuid())
  name                 String?
  email                String?       @unique
  emailVerified        DateTime?
  image                String?
  accounts             Account[]
  sessions             Session[]
  transactions         Transaction[] // 用户拥有的交易
  categories           Category[]
  auditLogs            AuditLog[]    // 用户的操作日志
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 交易类型枚举
enum TransactionType {
  INCOME  // 收入
  EXPENSE // 支出
}

// 支持的币种
enum Currency {
  USD
  JPY
  CNY
}

// 交易分类表 - 支持两级分类 (父类-子类)
model Category {
  id           String        @id @default(cuid())
  name         String
  type         TransactionType // 分类属于收入还是支出
  color        String?       // UI 显示颜色 (hex)
  icon         String?       // 图标名称

  // 两级分类支持
  parentId     String?       // 父分类ID (null表示这是一级分类)
  parent       Category?     @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children     Category[]    @relation("CategoryHierarchy")

  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([userId, name, type, parentId]) // 同一用户下同类型同父分类的名称不能重复
  @@index([userId, type])
  @@index([parentId])
}

// 交易记录表 - 核心业务实体
model Transaction {
  id             String          @id @default(cuid())

  // 原始交易信息
  originalAmount Decimal         @db.Decimal(19, 4) // 原币种金额,精度到4位小数
  currency       Currency        // 交易币种

  // 汇率信息 (关键字段)
  exchangeRate   Decimal         @db.Decimal(10, 6) // 对 CNY 的汇率,精度到6位小数
  amountCNY      Decimal         @db.Decimal(19, 4) // 折算后的 CNY 金额 (用于统计)

  // 交易元数据
  type           TransactionType // 收入/支出
  date           DateTime        @db.Date // 交易发生日期 (用于获取当日汇率)
  description    String?         // 交易描述
  notes          String?         @db.Text // 备注

  // 关联关系
  categoryId     String
  category       Category        @relation(fields: [categoryId], references: [id])
  userId         String
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 审计字段
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([userId, date]) // 优化按用户和日期查询
  @@index([userId, type, date]) // 优化收支统计查询
}

// 汇率缓存表 (可选,用于缓存历史汇率)
model ExchangeRate {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  fromCurrency Currency
  toCurrency   Currency @default(CNY) // 默认都转换为 CNY
  rate      Decimal  @db.Decimal(10, 6)
  source    String?  // 汇率来源 API
  createdAt DateTime @default(now())

  @@unique([date, fromCurrency, toCurrency]) // 同一天同一币种对的汇率唯一
  @@index([date, fromCurrency])
}

// 操作审计日志表 - 防止做假账
enum AuditAction {
  CREATE_TRANSACTION    // 创建交易
  DELETE_TRANSACTION    // 删除交易
  IMPORT_TRANSACTIONS   // 批量导入交易
  EXPORT_TRANSACTIONS   // 导出交易
}

model AuditLog {
  id              String      @id @default(cuid())
  action          AuditAction // 操作类型
  userId          String      // 操作人
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 操作详情
  entityType      String?     // 操作的实体类型 (如 "Transaction")
  entityId        String?     // 操作的实体ID
  details         String?     @db.Text // JSON格式的详细信息 (如删除的交易内容、导入的行数等)

  // 元数据
  ipAddress       String?     // 操作者IP地址
  userAgent       String?     @db.Text // 用户浏览器信息
  createdAt       DateTime    @default(now())

  @@index([userId, createdAt]) // 优化按用户和时间查询
  @@index([action, createdAt]) // 优化按操作类型查询
  @@index([entityType, entityId]) // 优化按实体查询
}
